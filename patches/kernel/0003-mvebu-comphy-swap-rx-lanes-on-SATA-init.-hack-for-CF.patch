From d38fdc0c609079c14c1df9dc1fa9a7232f94826e Mon Sep 17 00:00:00 2001
From: Rabeeh Khoury <rabeeh@solid-run.com>
Date: Sun, 18 Feb 2018 22:50:03 +0200
Subject: [PATCH] mvebu: comphy: swap rx lanes on SATA init. hack for CF-GT-8K

Signed-off-by: Rabeeh Khoury <rabeeh@solid-run.com>
---
 drivers/phy/phy-comphy-cp110.c | 5 +++++
 drivers/phy/phy-comphy-cp110.h | 6 ++++++
 2 files changed, 11 insertions(+)

diff --git a/drivers/phy/phy-comphy-cp110.c b/drivers/phy/phy-comphy-cp110.c
index d828ba4..82c0429 100644
--- a/drivers/phy/phy-comphy-cp110.c
+++ b/drivers/phy/phy-comphy-cp110.c
@@ -419,6 +419,11 @@ static int mvebu_cp110_comphy_sata_power_on(struct mvebu_comphy_priv *priv,
 	data |= 0x0 << HPIPE_G3_SET_0_G3_TX_SLEW_CTRL_EN_OFFSET;
 	reg_set(hpipe_addr + HPIPE_G3_SET_0_REG, data, mask);
 
+	/* Swap RX lane - hack to enable CF-GT-8K */
+	mask = HPIPE_SYNC_PATTERN_SWAP_RX_MASK;
+	data = 0x1 << HPIPE_SYNC_PATTERN_SWAP_RX_OFFSET;
+	reg_set(hpipe_addr + HPIPE_SYNC_PATTERN_REG, data, mask);
+
 	/* SERDES External Configuration 2 register */
 	mask = SD_EXTERNAL_CONFIG2_SSC_ENABLE_MASK;
 	data = 0x1 << SD_EXTERNAL_CONFIG2_SSC_ENABLE_OFFSET;
diff --git a/drivers/phy/phy-comphy-cp110.h b/drivers/phy/phy-comphy-cp110.h
index 264d7e5..96b5f22 100644
--- a/drivers/phy/phy-comphy-cp110.h
+++ b/drivers/phy/phy-comphy-cp110.h
@@ -249,6 +249,12 @@ extern const struct mvebu_comphy_soc_info cp110_comphy;
 #define HPIPE_CDR_LOCK_DET_EN_OFFSET		8
 #define HPIPE_CDR_LOCK_DET_EN_MASK		(0x1 << HPIPE_CDR_LOCK_DET_EN_OFFSET)
 
+#define HPIPE_SYNC_PATTERN_REG			0x90
+#define HPIPE_SYNC_PATTERN_SWAP_TX_OFFSET	10
+#define HPIPE_SYNC_PATTERN_SWAP_TX_MASK		(0x1 << HPIPE_SYNC_PATTERN_SWAP_TX_OFFSET)
+#define HPIPE_SYNC_PATTERN_SWAP_RX_OFFSET	11
+#define HPIPE_SYNC_PATTERN_SWAP_RX_MASK		(0x1 << HPIPE_SYNC_PATTERN_SWAP_RX_OFFSET)
+
 #define HPIPE_INTERFACE_REG			0x94
 #define HPIPE_INTERFACE_GEN_MAX_OFFSET		10
 #define HPIPE_INTERFACE_GEN_MAX_MASK		(0x3 << HPIPE_INTERFACE_GEN_MAX_OFFSET)
-- 
2.7.4

